@model List<LibraryManager.Models.Book>
@{
    ViewData["Title"] = "Danh sách Sách";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-5">
    <h2 class="mb-4 text-primary">Danh sách Sách</h2>

    <div class="card shadow-sm p-4 mb-4">
        <!-- Form tìm kiếm -->
        <form asp-action="Index" method="get" class="mb-3">
            <div class="input-group">
                <input type="text" name="searchString" class="form-control" placeholder="Tìm theo tên hoặc tác giả" value="@ViewBag.SearchString" />
                <button type="submit" class="btn btn-outline-primary"><i class="bi bi-search"></i> Tìm kiếm</button>
            </div>
        </form>

        <!-- Nút tạo -->
        <button class="btn btn-success mb-3"
                onclick="openModal('@Url.Action("Create","Books")', 'Tạo Sách')">
            <i class="bi bi-plus-circle"></i> Tạo mới
        </button>

        <!-- Bảng sách -->
        <div class="table-responsive">
            <table class="table table-striped table-hover table-bordered align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>Tiêu đề</th>
                        <th>Tác giả</th>
                        <th>Năm xuất bản</th>
                        <th>Số lượng</th>
                        <th>Thể loại</th>
                        <th>Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Any())
                    {
                        @foreach (var item in Model)
                        {
                            <tr>
                                <td>@item.Title</td>
                                <td>@item.Author</td>
                                <td>@item.PublicationYear</td>
                                <td>@item.Quantity</td>
                                <td>@item.Category.Name</td>
                                <td>
                                    <button class="btn btn-info btn-sm"
                                            onclick="openModal('@Url.Action("Details","Books", new { id=item.Id })', 'Chi tiết Sách')">
                                        <i class="bi bi-eye"></i> Chi tiết
                                    </button>
                                    <button class="btn btn-warning btn-sm"
                                            onclick="openModal('@Url.Action("Edit","Books", new { id=item.Id })', 'Sửa Sách')">
                                        <i class="bi bi-pencil"></i> Sửa
                                    </button>
                                    <button class="btn btn-danger btn-sm"
                                            onclick="openModal('@Url.Action("Delete","Books", new { id=item.Id })', 'Xóa Sách')">
                                        <i class="bi bi-trash"></i> Xóa
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="6" class="text-center text-muted">Không có sách nào.</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Phân trang -->
        @if (ViewBag.TotalPages > 1)
        {
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                    @if (ViewBag.CurrentPage > 1)
                    {
                        <li class="page-item">
                            <a class="page-link" href="@Url.Action("Index", new { page = ViewBag.CurrentPage - 1, searchString = ViewBag.SearchString })">Trước</a>
                        </li>
                    }
                    @for (int i = 1; i <= ViewBag.TotalPages; i++)
                    {
                        <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                            <a class="page-link" href="@Url.Action("Index", new { page = i, searchString = ViewBag.SearchString })">@i</a>
                        </li>
                    }
                    @if (ViewBag.CurrentPage < ViewBag.TotalPages)
                    {
                        <li class="page-item">
                            <a class="page-link" href="@Url.Action("Index", new { page = ViewBag.CurrentPage + 1, searchString = ViewBag.SearchString })">Sau</a>
                        </li>
                    }
                </ul>
            </nav>
        }
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="bookModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">...</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body"></div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function openModal(url, title) {
            $.get(url, function (res) {
                $("#bookModal .modal-title").text(title);
                $("#bookModal .modal-body").html(res);
                $("#bookModal").modal("show");
            });
        }

        // submit form qua AJAX
        $(document).on("submit", "form.ajax-form", function (e) {
            e.preventDefault();
            var form = $(this);
            $.ajax({
                url: form.attr("action"),
                type: form.attr("method"),
                data: form.serialize(),
                success: function (res) {
                    if (res.success) {
                        location.reload();
                    } else {
                        $("#bookModal .modal-body").html(res);
                    }
                }
            });
        });

        // xóa qua AJAX
        $(document).on("click", "#confirmDeleteBtn", function () {
            var id = $(this).data("id");
            $.post("@Url.Action("DeleteConfirmed", "Books")", { id: id }, function (res) {
                if (res.success) {
                    location.reload();
                }
            });
        });
    </script>
}
